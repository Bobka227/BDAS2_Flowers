@model OrderCreateVm
@using BDAS2_Flowers.Models.ViewModels.OrderModels
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Vytvořit objednávku";
}

<h2 class="mb-3">Vytvořit objednávku</h2>

@if (TempData["OrderError"] is string err && !string.IsNullOrWhiteSpace(err))
{
    <div class="alert alert-danger">@err</div>
}

<form method="post" asp-action="Create" asp-controller="Orders" class="row g-3">
    @Html.AntiForgeryToken()

    <div class="col-md-4">
        <label class="form-label">Doručení</label>
        <select class="form-select"
                asp-for="DeliveryMethodId"
                asp-items="@(new SelectList(Model.DeliveryMethods, "Id", "Name"))"></select>
    </div>

    <div class="col-md-4">
        <label class="form-label">Prodejna</label>
        <select class="form-select"
                asp-for="ShopId"
                asp-items="@(new SelectList(Model.Shops, "Id", "Name"))"></select>
    </div>

    <div class="col-md-4">
        <label class="form-label">Adresa</label>
        <select class="form-select"
                asp-for="AddressId"
                asp-items="@(new SelectList(Model.Addresses, "Id", "Name", Model.AddressId))">
            <option value="">-- vyberte existující adresu --</option>
        </select>
    </div>

    <div class="col-md-4">
        <label class="form-label">Platba</label>
        <select class="form-select" asp-for="PaymentType" id="PaymentType">
            <option value="cash">Hotově</option>
            <option value="card">Kartou</option>
            <option value="cupon">Kupon</option>
        </select>
    </div>

    <div class="col-md-4" id="cardFields" style="display:none">
        <label class="form-label">Číslo karty</label>
        <input class="form-control" asp-for="CardNumber"
               placeholder="1111 2222 3333 4444"
               inputmode="numeric" autocomplete="cc-number"
               pattern="[0-9 ]{12,23}" maxlength="23" />
        <div class="form-text">V DB ukládáme pouze poslední 4 číslice.</div>
    </div>

    <div class="col-md-4" id="cashFields" style="display:none">
        <label class="form-label">Přijato (hotově)</label>
        <input class="form-control" asp-for="CashAccepted" type="number" step="0.01" min="0"/>
    </div>

    <div class="col-md-4" id="couponFields" style="display:none">
        <label class="form-label">Kód kupónu</label>
        <input class="form-control" asp-for="CuponCode" placeholder="Např. EXTRASLEVA500"/>
        <div class="form-text">Kupón musí pokrýt celou cenu objednávky.</div>
    </div>

    <div class="col-12">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" asp-for="UseNewAddress" id="chkNewAddress"/>
            <label class="form-check-label" for="chkNewAddress">
                Chci zadat <strong>novou adresu</strong>
            </label>
        </div>
    </div>

    <div class="col-lg-6">
        <label class="form-label">Ulice</label>
        <input class="form-control" asp-for="Street" id="Street" />
    </div>
    <div class="col-6 col-lg-2">
        <label class="form-label">Číslo domu</label>
        <input class="form-control" asp-for="HouseNumber" id="HouseNumber" type="number" min="1"/>
    </div>
    <div class="col-6 col-lg-2">
        <label class="form-label">PSČ</label>
        <input class="form-control" asp-for="PostalCode" id="PostalCode" type="number" min="1"/>
    </div>

    <div class="col-12">
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th style="width:55%">Produkt</th>
                        <th style="width:20%">Množství</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="items">
                    @for (var i = 0; i < Model.Items.Count; i++)
                    {
                        <tr>
                            <td>
                                <select class="form-select" name="Items[@i].ProductId">
                                    @foreach (var p in Model.Products)
                                    {
                                        <option value="@p.Id" selected="@(Model.Items[i].ProductId == p.Id)">@p.Name</option>
                                    }
                                </select>
                            </td>
                            <td>
                                <input class="form-control" type="number" min="1" name="Items[@i].Quantity" value="@(Model.Items[i].Quantity > 0 ? Model.Items[i].Quantity : 1)"/>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">Smazat</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <button type="button" class="btn btn-outline-primary" onclick="addRow()">Přidat položku</button>
    </div>

    <div class="col-12">
        <div class="alert alert-secondary mt-3">
            Aktuální cena objednávky:
            <strong>@Model.CartTotal.ToString("0 Kč")</strong>
        </div>
    </div>

    <div class="col-12 d-flex gap-2">
        <a class="btn btn-light" href="/cart">Zpět do košíku</a>
        <button class="btn btn-primary" type="submit">Odeslat objednávku</button>
    </div>
</form>

@section Scripts {
        <script>
            function toggleAddress() {
                const useNew = document.getElementById('chkNewAddress').checked;
                ['Street','HouseNumber','PostalCode'].forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    el.disabled = !useNew;
                    el.required = useNew;
                });
                const selAddr = document.querySelector('select[name="AddressId"]');
                if (selAddr) {
                    if (useNew) { selAddr.setAttribute('disabled','disabled'); selAddr.value = ''; }
                    else { selAddr.removeAttribute('disabled'); }
                }
            }

                function togglePayment() {
                    const type = document.getElementById('PaymentType')?.value ?? 'cash';
                    const card = document.getElementById('cardFields');
                    const cash = document.getElementById('cashFields');
                    const coupon = document.getElementById('couponFields');

                    if (card) card.style.display = (type === 'card') ? '' : 'none';
                    if (cash) cash.style.display = (type === 'cash') ? '' : 'none';
                    if (coupon) coupon.style.display = (type === 'cupon') ? '' : 'none';
                }

            const products = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Products));

            function addRow() {
                const tbody = document.getElementById('items');
                const index = tbody.rows.length;
                const sel = `<select class="form-select" name="Items[${index}].ProductId">` +
                    products.map(p => `<option value="${p.Id}">${p.Name}</option>`).join('') +
                    `</select>`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sel}</td>
                    <td><input class="form-control" type="number" min="1" name="Items[${index}].Quantity" value="1" /></td>
                    <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove(); recalcTotal();">Smazat</button></td>`;
                tbody.appendChild(row);
                recalcTotal();
            }

            function recalcTotal() {
                const priceMap = {};
                products.forEach(p => priceMap[p.Id] = p.Price ?? 0);
                let sum = 0;

                document.querySelectorAll('#items tr').forEach(tr => {
                    const sel = tr.querySelector('select[name$=".ProductId"]');
                    const qtyInput = tr.querySelector('input[name$=".Quantity"]');
                    if (!sel || !qtyInput) return;
                    const id = parseInt(sel.value);
                    const qty = parseInt(qtyInput.value) || 0;
                    if (!id || qty <= 0) return;
                    const price = priceMap[id] || 0;
                    sum += price * qty;
                });

                const span = document.getElementById('orderTotal');
                if (span) {
                    span.textContent =
                        sum.toLocaleString('cs-CZ', { style: 'currency', currency: 'CZK', maximumFractionDigits: 0 });
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('chkNewAddress')?.addEventListener('change', toggleAddress);
                document.getElementById('PaymentType')?.addEventListener('change', togglePayment);
                document.querySelectorAll('input[name="CuponFallbackType"]').forEach(r =>
                    r.addEventListener('change', togglePayment));

                const items = document.getElementById('items');
                if (items) {
                    items.addEventListener('change', recalcTotal);
                    items.addEventListener('input', recalcTotal);
                }

                toggleAddress();
                togglePayment();
                recalcTotal();
            });
        </script>
}