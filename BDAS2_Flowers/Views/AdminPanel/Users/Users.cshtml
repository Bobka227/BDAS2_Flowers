@using System.Security.Claims
@model List<(string Email,string Name,string Role,int Orders,string Segment)>

@{
    ViewData["Title"] = "Uživatelé";
    var currentEmail = User.FindFirstValue(ClaimTypes.Email);
}

<div class="container py-4">
    @if (TempData["Msg"] is string m)
    {
        <div class="alert alert-success">@m</div>
    }

    <h1 class="h4 mb-3">Uživatelé</h1>
    <table class="table table-sm align-middle">
        <thead>
            <tr>
                <th>E-mail</th>
                <th>Jméno</th>
                <th>Role</th>
                <th>Objednávek</th>
                <th>Segment</th>
                <th class="text-end">Akce</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var u in Model)
            {
                var seg = (u.Segment ?? "").ToUpperInvariant();
                var badgeClass = seg switch
                {
                    "GOLD" => "bg-warning text-dark",      
                    "SILVER" => "bg-secondary",            
                    "BRONZE" => "bg-brown text-light",      
                    "NEW" => "bg-primary",              
                    "INACTIVE" => "bg-dark",               
                    _ => "bg-light text-muted"
                };

                <tr>
                    <td>
                        <a href="/admin/users/@u.Email/orders">@u.Email</a>
                    </td>
                    <td>@u.Name</td>
                    <td>@u.Role</td>
                    <td>@u.Orders</td>
                    <td>
                        <span class="badge @badgeClass">
                            @u.Segment
                        </span>
                    </td>
                    <td class="text-end">
                        @if (u.Role == "Admin")
                        {
                            <form action="/admin/users/@u.Email/role" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="roleName" value="Customer" />
                                <button class="btn btn-sm btn-outline-secondary">Set Customer</button>
                            </form>
                        }
                        else
                        {
                            <form action="/admin/users/@u.Email/role" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="roleName" value="Admin" />
                                <button class="btn btn-sm btn-brand">Make Admin</button>
                            </form>
                        }

                        @if (!string.Equals(u.Email, currentEmail, StringComparison.OrdinalIgnoreCase))
                        {
                            <form asp-controller="AdminUsers"
                                  asp-action="Impersonate"
                                  method="post"
                                  class="d-inline ms-1">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="email" value="@u.Email" />
                                <button type="submit" class="btn btn-sm btn-outline-dark">
                                    Emulovat
                                </button>
                            </form>
                        }

                        @if (!string.Equals(u.Email, currentEmail, StringComparison.OrdinalIgnoreCase))
                        {
                            <form method="post"
                                  action="/admin/users/@u.Email/delete"
                                  class="d-inline ms-1"
                                  onsubmit="return confirm('Opravdu smazat uživatele @u.Email?');">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    Smazat
                                </button>
                            </form>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<style>
    .badge.bg-brown {
        background-color: #8b5a2b;
    }
</style>
