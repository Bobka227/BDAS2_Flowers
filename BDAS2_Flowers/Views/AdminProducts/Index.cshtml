@model List<(int Id, string Title, string TypeName, int Stock, decimal Price, int TypeId)>

@{
    ViewData["Title"] = "Products";
    var typeOptions = (IEnumerable<(int Id, string Name)>)(ViewBag.Types ?? Enumerable.Empty<(int, string)>());
    var q = (string)(ViewBag.Query ?? "");
    int? curType = ViewBag.TypeId as int?;
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Products</h2>

    <div class="d-flex align-items-center gap-2 flex-wrap">

        <form id="filterForm" class="d-flex align-items-center gap-2" onsubmit="return false">
            <select id="filterType" class="form-select form-select-sm" style="min-width:220px">
                <option value="0">Choose type...</option>
                @foreach (var t in typeOptions)
                {
                    <option value="@t.Id" selected="@(curType == t.Id)">@t.Name</option>
                }
            </select>

            <input id="filterQ" value="@q" class="form-control form-control-sm"
                   placeholder="Search title..." style="width:180px" />

            <a class="btn btn-brand btn-sm" href="@Url.Action("Index", "AdminProducts")">Reset</a>
        </form>

        <form asp-action="Restock" method="post" class="d-flex align-items-center gap-2">
            @Html.AntiForgeryToken()
            <select name="typeId" class="form-select form-select-sm" style="min-width:220px">
                @foreach (var t in typeOptions)
                {
                    <option value="@t.Id">@t.Name</option>
                }
            </select>
            <input name="delta" type="number" class="form-control form-control-sm"
                   placeholder="Δ stock (např. 25)" style="width:160px" />
            <button class="btn btn-outline-secondary btn-brand-second btn-sm">
                <i class="bi bi-box-seam"></i> Restock
            </button>
        </form>

        <a class="btn btn-primary btn-brand" asp-action="Create">Add product</a>
    </div>
</div>

@if (TempData["Msg"] != null)
{
    <div class="alert alert-info">@TempData["Msg"]</div>
}

<div id="grid">
    @await Html.PartialAsync("_ProductsTable", Model)
</div>

@section Scripts {
    <script>
        (function(){
          const sel = document.getElementById('filterType');
          const q   = document.getElementById('filterQ');
          const grid= document.getElementById('grid');

          async function reload() {
            const p = new URLSearchParams();
            if (sel.value && sel.value !== "0") p.set('typeId', sel.value);
            if (q.value) p.set('q', q.value);
            const res = await fetch('/admin/products/list?' + p.toString(),
              { headers: {'X-Requested-With':'XMLHttpRequest'}});
            grid.innerHTML = await res.text();
          }

          let t=null;
          q.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(reload, 250); });
          sel.addEventListener('change', reload);
        })();
    </script>
}
